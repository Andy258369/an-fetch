name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥å’Œæµ‹è¯•
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: ä»£ç æ ¼å¼æ£€æŸ¥
      run: npm run lint

    - name: TypeScript ç±»å‹æ£€æŸ¥
      run: npm run type-check

    - name: è¿è¡Œæµ‹è¯•
      run: npm run test:coverage

    - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        fail_ci_if_error: false

  # æ„å»ºæ£€æŸ¥
  build:
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: æ„å»ºé¡¹ç›®
      run: npm run build

    - name: æ£€æŸ¥æ„å»ºäº§ç‰©
      run: |
        ls -la dist/
        test -f dist/index.js
        test -f dist/index.d.ts

    # ç¼“å­˜æ„å»ºäº§ç‰©ä¾›å‘å¸ƒä½¿ç”¨
    - name: ç¼“å­˜æ„å»ºäº§ç‰©
      uses: actions/cache@v3
      with:
        path: dist
        key: build-${{ github.sha }}

  # è‡ªåŠ¨å‘å¸ƒåˆ° npmï¼ˆä»…åœ¨ main/master åˆ†æ”¯ï¼‰
  publish:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
    - name: Checkout ä»£ç 
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´çš„ git å†å²ï¼Œç”¨äºç‰ˆæœ¬æ ‡ç­¾
        fetch-depth: 0

    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: å®‰è£…ä¾èµ–
      run: npm ci

    - name: æ¢å¤æ„å»ºäº§ç‰©
      uses: actions/cache@v3
      with:
        path: dist
        key: build-${{ github.sha }}

    - name: é‡æ–°æ„å»ºï¼ˆå¦‚æœç¼“å­˜å¤±è´¥ï¼‰
      run: |
        if [ ! -d "dist" ]; then
          npm run build
        fi

    - name: æ£€æŸ¥æ˜¯å¦éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬
      id: version-check
      run: |
        # è·å–å½“å‰ package.json ä¸­çš„ç‰ˆæœ¬
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥è¯¥ç‰ˆæœ¬æ˜¯å¦å·²ç»åœ¨ npm ä¸Šå­˜åœ¨
        if npm view an-fetch@$CURRENT_VERSION version 2>/dev/null; then
          echo "version-exists=true" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬ $CURRENT_VERSION å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"
        else
          echo "version-exists=false" >> $GITHUB_OUTPUT
          echo "ç‰ˆæœ¬ $CURRENT_VERSION ä¸å­˜åœ¨ï¼Œå‡†å¤‡å‘å¸ƒ"
        fi

    - name: åˆ›å»º Git æ ‡ç­¾
      if: steps.version-check.outputs.version-exists == 'false'
      run: |
        VERSION=${{ steps.version-check.outputs.current-version }}
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag -a "v$VERSION" -m "Release version $VERSION"
        git push origin "v$VERSION"

    - name: å‘å¸ƒåˆ° npm
      if: steps.version-check.outputs.version-exists == 'false'
      run: npm publish --access public
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: åˆ›å»º GitHub Release
      if: steps.version-check.outputs.version-exists == 'false'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version-check.outputs.current-version }}
        release_name: Release v${{ steps.version-check.outputs.current-version }}
        body: |
          ## ğŸš€ æ–°ç‰ˆæœ¬å‘å¸ƒ v${{ steps.version-check.outputs.current-version }}
          
          ### ğŸ“¦ å®‰è£…
          ```bash
          npm install an-fetch@${{ steps.version-check.outputs.current-version }}
          ```
          
          ### ğŸ”— é“¾æ¥
          - [npm åŒ…](https://www.npmjs.com/package/an-fetch)
          - [å®Œæ•´æ›´æ–°æ—¥å¿—](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          
          è‡ªåŠ¨ç”Ÿæˆçš„å‘å¸ƒè¯´æ˜ï¼Œè¯¦ç»†æ›´æ”¹è¯·æŸ¥çœ‹æäº¤å†å²ã€‚
        draft: false
        prerelease: false

  # é€šçŸ¥å‘å¸ƒç»“æœ
  notify:
    runs-on: ubuntu-latest
    needs: [publish]
    if: always() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
    - name: å‘å¸ƒæˆåŠŸé€šçŸ¥
      if: needs.publish.result == 'success'
      run: |
        echo "ğŸ‰ æˆåŠŸå‘å¸ƒæ–°ç‰ˆæœ¬åˆ° npm!"
        echo "ğŸ“¦ åŒ…åœ°å€: https://www.npmjs.com/package/an-fetch"

    - name: å‘å¸ƒè·³è¿‡é€šçŸ¥
      if: needs.publish.result == 'skipped'
      run: |
        echo "â„¹ï¸ ç‰ˆæœ¬å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒ"

    - name: å‘å¸ƒå¤±è´¥é€šçŸ¥
      if: needs.publish.result == 'failure'
      run: |
        echo "âŒ å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        exit 1